<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { 
    getFirestore, collection, onSnapshot, query, orderBy, 
    addDoc, getDocs, deleteDoc, doc , where
  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  // Import der Konfiguration
  import { firebaseConfig } from "./firebase-config.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const PIN = "112";

  // === Startschutz ===
  window.addEventListener("DOMContentLoaded", () => {
    const entered = prompt("PIN eingeben:");
    if (entered === PIN) {
      document.getElementById("content").style.display = "block";
      loadExercises();
      loadFeedback();
    } else {
      alert("Falsche PIN ‚Äì Zugriff verweigert.");
    }
  });

  // === Feedbacks live laden ===
  function loadFeedback() {
    const q = query(collection(db, "feedbacks"), orderBy("timestamp", "desc"));
    onSnapshot(q, (snapshot) => {
      const feedbacks = [];
      snapshot.forEach((d) => feedbacks.push(d.data()));
      window.allFeedbacks = feedbacks;
      console.log("[Feedback] geladen:", feedbacks.length);
      // Wenn noch keine √úbung gew√§hlt, Standard auf erste setzen
      const current = document.getElementById("exerciseFilter")?.value;
      if (!current) updateChart(feedbacks);
      else applyFilter();
    });
  }

  // === √úbungen live laden ===
  function loadExercises() {
    const selectPrimary = document.getElementById("exerciseFilter");
    const selectCompare = document.getElementById("compareFilter"); // üî• NEU
    if (!selectPrimary || !selectCompare) return;
    const ref = collection(db, "exercises");

    onSnapshot(ref, (snapshot) => {
      selectPrimary.innerHTML = "";
      selectCompare.innerHTML = '<option value="" selected>Kein Vergleich</option>'; // üî• Vergleichsfilter initialisieren

      const names = [];
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        if (data?.name) names.push(data.name);
      });
      names.sort((a,b) => a.localeCompare(b,"de"));

      // Option "Alle √úbungen" f√ºr den Hauptfilter hinzuf√ºgen
      const allOpt = document.createElement("option");
      allOpt.value = "";
      allOpt.textContent = "Alle √úbungen (Gesamt)";
      selectPrimary.appendChild(allOpt);

      names.forEach((n) => {
        // Optionen f√ºr Hauptfilter
        let optP = document.createElement("option");
        optP.value = n;
        optP.textContent = n;
        selectPrimary.appendChild(optP);
        
        // üî• Optionen f√ºr Vergleichsfilter
        let optC = document.createElement("option");
        optC.value = n;
        optC.textContent = n;
        selectCompare.appendChild(optC);
      });
      console.log("[√úbungen] aktualisiert:", names.length, "plus Alle-Option");

      if (window.allFeedbacks) applyFilter();
    }, (err) => console.error("[√úbungen] Fehler:", err));
}

  // === √úbung hinzuf√ºgen ===
  async function addExercise() {
    const newEx = prompt("Neue √úbung hinzuf√ºgen:");
    if (!newEx || !newEx.trim()) return;
    const name = newEx.trim();
    try {
      await addDoc(collection(db, "exercises"), {
        name,
        createdAt: new Date().toISOString()
      });
      alert(`√úbung "${name}" wurde hinzugef√ºgt.`);
    } catch (e) {
      console.error("Fehler beim Speichern:", e);
    }
  }

  // === √úbung l√∂schen ===
  async function deleteExercise() {
    const select = document.getElementById("exerciseFilter");
    const selected = select.value;
    if (!selected) return alert("Bitte eine √úbung ausw√§hlen.");
    if (!confirm(`M√∂chtest du "${selected}" wirklich l√∂schen?`)) return;
    try {
      const qSnap = await getDocs(collection(db, "exercises"));
      qSnap.forEach(async (d) => {
        const data = d.data();
        if (data.name === selected) {
          await deleteDoc(doc(db, "exercises", d.id));
        }
      });
      alert(`√úbung "${selected}" wurde gel√∂scht.`);
    } catch (e) {
      console.error("Fehler beim L√∂schen:", e);
    }
  }

  window.addExercise = addExercise;
  window.deleteExercise = deleteExercise;

  // === Filter & Diagramm ===
  function applyFilter() {
    const selected = document.getElementById("exerciseFilter").value;
    const all = window.allFeedbacks || [];
    const filtered = selected ? all.filter(f => f.exercise === selected) : all;
    updateChart(filtered);
  }
  window.applyFilter = applyFilter;

  function updateChart(feedbacks) {
    const counts = [0,0,0,0,0];
    let total = 0;
    feedbacks.forEach(f => {
      if (!f.rating) return;
      counts[f.rating-1]++;
      total += f.rating;
    });

    const avg = feedbacks.length ? (total / feedbacks.length).toFixed(2) : "-";
    document.getElementById("avgRating").textContent = avg;

    const ctx = document.getElementById("feedbackChart").getContext("2d");
    if (window.chartInstance) window.chartInstance.destroy();
    window.chartInstance = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["1","2","3","4","5"],
        datasets: [{
          label: "Bewertungen",
          data: counts,
          backgroundColor: "#b30000"
        }]
      },
      options: { scales: { y: { beginAtZero: true } } }
    });

    // Kommentare rendern
    const list = document.getElementById("commentsList");
    const currentEx = document.getElementById("exerciseFilter").value;
    
    if (feedbacks.length === 0) {
      list.innerHTML = "<li>Keine R√ºckmeldungen vorhanden.</li>";
    } else {
      list.innerHTML = feedbacks
        .filter(f => f.comment)
        .map(f => {
            const prefix = currentEx ? '' : `[${f.exercise || "-"}] `;
            return`<li>${prefix}${f.comment}</li>`
        })
        .join('');
    }

    window.currentFeedbacks = feedbacks;
    window.currentExercise = document.getElementById("exerciseFilter").value;
  }

  // === PDF Export ===
  async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const feedbacks = window.currentFeedbacks || [];
    if (!feedbacks.length) return alert("Keine Feedbacks zum Exportieren!");
    const exercise = window.currentExercise || "Gesamt";

    doc.setFontSize(18);
    doc.text(`Feuerwehr Feedback ‚Äì ${exercise}`, 14, 20);
    doc.setFontSize(12);
    const avg = document.getElementById("avgRating").textContent;
    doc.text(`Durchschnittsbewertung: ${avg}`, 14, 30);
    doc.text(`Anzahl Feedbacks: ${feedbacks.length}`, 14, 37);

    let y = 50;
    feedbacks.forEach((f, i) => {
      const comment = f.comment || "";
      const line = `${i + 1}. [${f.rating}/5] ${comment}`;
      const split = doc.splitTextToSize(line, 180);
      doc.text(split, 14, y);
      y += split.length * 7;
      if (y > 270) { doc.addPage(); y = 20; }
    });

    doc.save(`Feedback_${exercise}_${new Date().toISOString().slice(0,10)}.pdf`);
  }
  window.exportPDF = exportPDF;



    // === Alte Feedbacks l√∂schen ===
    async function deleteOldFeedbacks() {
        // Stichtag berechnen: Heute minus 2 Jahre (in ISO-String-Format)
        const twoYearsAgo = new Date();
        twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
        const cutOffTimestamp = twoYearsAgo.toISOString();
        
        // Doppelte Sicherheitsabfrage
        if (!confirm(`M√∂chtest du WIRKLICH alle Feedbacks l√∂schen, die √§lter als ${twoYearsAgo.toLocaleDateString()} sind? Dieser Schritt kann NICHT r√ºckg√§ngig gemacht werden.`)) {
            return;
        }
    
        try {
            const feedbacksRef = collection(db, "feedbacks");
            // Abfrage: Suche Feedbacks, deren 'timestamp' (string) vor dem Stichtag liegt
            const q = query(
                feedbacksRef, 
                orderBy("timestamp"),
                where("timestamp", "<", cutOffTimestamp)
            );
            
            const qSnap = await getDocs(q);
            const count = qSnap.docs.length;
    
            if (count === 0) {
                alert("Es wurden keine Feedbacks gefunden, die √§lter als 2 Jahre sind.");
                return;
            }
    
            // Batch-L√∂schung (effizienter, falls es sehr viele Feedbacks sind, 
            // hier machen wir es einfach mit individuellem L√∂schen)
            
            console.log(`[Datenhygiene] L√∂sche ${count} alte Feedbacks...`);
            
            const deletePromises = qSnap.docs.map(d => deleteDoc(doc(db, "feedbacks", d.id)));
            
            await Promise.all(deletePromises);
            
            alert(`${count} Feedbacks, die √§lter als 2 Jahre sind, wurden erfolgreich gel√∂scht.`);
            
        } catch (e) {
            console.error("Fehler beim L√∂schen alter Feedbacks:", e);
            alert("Fehler beim L√∂schen alter Feedbacks. Pr√ºfe die Konsole.");
        }
    }
    
    window.deleteOldFeedbacks = deleteOldFeedbacks; // Funktion global verf√ºgbar machen
      
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f7f7f7; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 750px; margin: auto; }
    h1,h2 { color: #b30000; }
    #content { display: none; }
    #avgRating { font-size: 1.4em; font-weight: bold; }
    select, button {
      background: #b30000; color: white; border: none; padding: 8px 14px;
      border-radius: 6px; cursor: pointer; margin-bottom: 10px;
    }
    button:hover { background: #e00000; }
    select { margin-right: 8px; }
  </style>
</head>

<body>
  <div id="content">
    <div class="card">
      <h1>üìä Feuerwehr Feedback ‚Äì Auswertung</h1>
      <p>Durchschnittsbewertung: <span id="avgRating">-</span></p>
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <select id="exerciseFilter" onchange="applyFilter()"></select>

        <select id="compareFilter" onchange="applyFilter()">
          <option value="" selected>Kein Vergleich</option>
        </select>
        
        <button onclick="addExercise()">‚ûï Hinzuf√ºgen</button>
        <button onclick="deleteExercise()">üóëÔ∏è L√∂schen</button>
        <button onclick="exportPDF()">üìÑ PDF exportieren</button>
        <button onclick="deleteOldFeedbacks()">üßπ Feedbacks >2 J. l√∂schen</button>
      </div>
      <canvas id="feedbackChart"></canvas>
    </div>

    <div class="card">
      <h2>üí¨ Kommentare</h2>
      <ul id="commentsList"></ul>
    </div>
  </div>
</body>
</html>
