<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { 
    getFirestore, collection, onSnapshot, query, orderBy, 
    addDoc, getDocs, deleteDoc, doc , where, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  // Import der Konfiguration
  import { firebaseConfig } from "./firebase-config.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const PIN = "112";

  // === Startschutz ===
  window.addEventListener("DOMContentLoaded", () => {
    const entered = prompt("PIN eingeben:");
    if (entered === PIN) {
      document.getElementById("content").style.display = "block";
      loadExercises();
      loadFeedback();
    } else {
      alert("Falsche PIN ‚Äì Zugriff verweigert.");
    }
  });

  // === √úbung sperren/entsperren ===
async function toggleLockStatus() {
    const select = document.getElementById("exerciseFilter");
    const selected = select.value;
    if (!selected) return alert("Bitte eine √úbung ausw√§hlen.");

    try {
        const qSnap = await getDocs(collection(db, "exercises"));
        let currentStatus = null;
        let docRef = null;

        // Finde das passende Dokument und den aktuellen Status
        qSnap.forEach((d) => {
            const data = d.data();
            if (data.name === selected) {
                currentStatus = !!data.isLocked; // Konvertiert zu Boolean, false falls Feld fehlt
                docRef = doc(db, "exercises", d.id);
            }
        });
        
        if (!docRef) return alert("√úbung nicht in Datenbank gefunden.");

        const newStatus = !currentStatus;
        
        // Aktualisiere den Status in Firestore
        await updateDoc(docRef, {
            isLocked: newStatus
        });

        alert(`√úbung "${selected}" wurde ${newStatus ? 'Gesperrt' : 'Entsperrt'}.`);
        
        // Aktualisiere den Button-Text sofort
        updateLockButtonText(newStatus); 
        
    } catch (e) {
        console.error("Fehler beim Sperren/Entsperren:", e);
        alert("Fehler beim √Ñndern des Status!");
    }
}
window.toggleLockStatus = toggleLockStatus;


// === Zus√§tzliche Funktion: Button-Text aktualisieren ===
// Stellt sicher, dass der Buttontext nach der Filterauswahl den korrekten Status anzeigt.
function updateLockButtonText(isLocked) {
    const btn = document.getElementById('lockButton');
    btn.textContent = isLocked ? '‚úÖ √úbung entsperren' : 'üîí √úbung sperren';
    btn.style.backgroundColor = isLocked ? '#00703c' : '#b30000'; // Gr√ºne oder rote Farbe
}
// Rufe diese Funktion auch im applyFilter auf, um den Status der gew√§hlten √úbung anzuzeigen.
window.updateLockButtonText = updateLockButtonText;

  // === Feedbacks live laden ===
  function loadFeedback() {
    const q = query(collection(db, "feedbacks"), orderBy("timestamp", "desc"));
    onSnapshot(q, (snapshot) => {
      const feedbacks = [];
      snapshot.forEach((d) => feedbacks.push(d.data()));
      window.allFeedbacks = feedbacks;
      console.log("[Feedback] geladen:", feedbacks.length);
      // Wenn noch keine √úbung gew√§hlt, Standard auf erste setzen
      const current = document.getElementById("exerciseFilter")?.value;
      if (!current) updateChart(feedbacks);
      else applyFilter();
    });
  }

  // === √úbungen live laden ===
  function loadExercises() {
    const selectPrimary = document.getElementById("exerciseFilter");
    const selectCompare = document.getElementById("compareFilter"); // üî• NEU
    if (!selectPrimary || !selectCompare) return;
    const ref = collection(db, "exercises");

    onSnapshot(ref, (snapshot) => {
      selectPrimary.innerHTML = "";
      selectCompare.innerHTML = '<option value="" selected>Kein Vergleich</option>'; // üî• Vergleichsfilter initialisieren

      const names = [];
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        if (data?.name) {
          names.push(data.name);
          window.exerciseStatuses = window.exerciseStatuses || {};
          window.exerciseStatuses[data.name] = !!data.isLocked;
        }
      });
      names.sort((a,b) => a.localeCompare(b,"de"));

      // Option "Alle √úbungen" f√ºr den Hauptfilter hinzuf√ºgen
      const allOpt = document.createElement("option");
      allOpt.value = "";
      allOpt.textContent = "Alle √úbungen (Gesamt)";
      selectPrimary.appendChild(allOpt);

      names.forEach((n) => {
        // Optionen f√ºr Hauptfilter
        let optP = document.createElement("option");
        optP.value = n;
        optP.textContent = n;
        selectPrimary.appendChild(optP);
        
        // üî• Optionen f√ºr Vergleichsfilter
        let optC = document.createElement("option");
        optC.value = n;
        optC.textContent = n;
        selectCompare.appendChild(optC);
      });
      console.log("[√úbungen] aktualisiert:", names.length, "plus Alle-Option");

      if (window.allFeedbacks) applyFilter();
      const initialEx = document.getElementById("exerciseFilter").value;
      if(initialEx && window.exerciseStatuses) updateLockButtonText(window.exerciseStatuses[initialEx]);
    }, (err) => console.error("[√úbungen] Fehler:", err));
}

    // === √úbung hinzuf√ºgen ===
    async function addExercise() {
        const newEx = prompt("Neue √úbung hinzuf√ºgen:");
        if (!newEx || !newEx.trim()) return;
        
        // üî• NEU: Datum hinzuf√ºgen
        const now = new Date();
        // Beispielformat: 01.11.2025
        const dateStr = now.toLocaleDateString('de-DE', { year: 'numeric', month: '2-digit', day: '2-digit' }); 
        
        // Kombiniert Datum und Eingabe zu einem eindeutigen Namen
        const name = `${dateStr} ‚Äì ${newEx.trim()}`; 
        
        try {
          await addDoc(collection(db, "exercises"), {
            name,
            createdAt: new Date().toISOString()
          });
          alert(`√úbung "${name}" wurde hinzugef√ºgt.`);
        } catch (e) {
          console.error("Fehler beim Speichern:", e);
        }
}

    // === √úbung und zugeh√∂rige Feedbacks l√∂schen ===
    async function deleteExercise() {
        const select = document.getElementById("exerciseFilter");
        const selected = select.value;
        if (!selected) return alert("Bitte eine √úbung ausw√§hlen.");
        
        if (!confirm(`M√∂chtest du "${selected}" WIRKLICH l√∂schen? Dadurch werden auch ALLE ${selected} zugeh√∂rigen Feedbacks unwiederbringlich gel√∂scht!`)) return;
        
        try {
            let deletedFeedbackCount = 0;
            
            // --- PHASE 1: Zugeh√∂rige Feedbacks l√∂schen ---
            const feedbacksRef = collection(db, "feedbacks");
            // Finde alle Feedbacks, deren 'exercise' Feld mit der ausgew√§hlten √úbung √ºbereinstimmt
            const qFeedback = query(feedbacksRef, where("exercise", "==", selected));
            const qSnapFeedback = await getDocs(qFeedback);
            
            if (qSnapFeedback.docs.length > 0) {
                console.log(`[L√∂schen] Finde ${qSnapFeedback.docs.length} Feedbacks f√ºr "${selected}"...`);
                
                const deleteFeedbackPromises = qSnapFeedback.docs.map(d => deleteDoc(doc(db, "feedbacks", d.id)));
                await Promise.all(deleteFeedbackPromises);
                
                deletedFeedbackCount = qSnapFeedback.docs.length;
            }
    
            // --- PHASE 2: √úbung selbst l√∂schen ---
            const exercisesRef = collection(db, "exercises");
            const qSnapExercise = await getDocs(exercisesRef);
            
            qSnapExercise.forEach(async (d) => {
                const data = d.data();
                if (data.name === selected) {
                    await deleteDoc(doc(db, "exercises", d.id));
                }
            });
            
            alert(`√úbung "${selected}" und ${deletedFeedbackCount} zugeh√∂rige Feedbacks wurden gel√∂scht.`);
            
        } catch (e) {
            console.error("Fehler beim L√∂schen:", e);
            alert("Fehler beim L√∂schen der √úbung oder der Feedbacks!");
        }
    }

  window.addExercise = addExercise;
  window.deleteExercise = deleteExercise;

  // === Filter & Diagramm ===
  function applyFilter() {
      const selectedPrimary = document.getElementById("exerciseFilter").value;
      const selectedCompare = document.getElementById("compareFilter").value; // üî• NEU
      
      const all = window.allFeedbacks || [];
      
      // 1. Prim√§res Dataset filtern
      const primaryFeedbacks = selectedPrimary ? all.filter(f => f.exercise === selectedPrimary) : all;
      window.currentFeedbacks = primaryFeedbacks;
      window.currentExercise = selectedPrimary || "Gesamt";
  
      // 2. Vergleichs-Dataset filtern
      let compareFeedbacks = [];
      if (selectedCompare) {
          compareFeedbacks = all.filter(f => f.exercise === selectedCompare);
      }
      if (window.exerciseStatuses && selectedPrimary) {
        updateLockButtonText(window.exerciseStatuses[selectedPrimary]);
    } else {
        updateLockButtonText(false); // Wenn 'Alle √úbungen' oder keine √úbung gew√§hlt
    }
      
      updateChart(primaryFeedbacks, compareFeedbacks, selectedCompare); // üî• √úbergabe beider Datensets
  }
  window.applyFilter = applyFilter;

  function updateChart(primaryFeedbacks, compareFeedbacks, selectedCompare) { // üî• Parameter hinzugef√ºgt
    
    // --- 1. Prim√§res Dataset (√úbung A) berechnen ---
    const countsPrimary = [0,0,0,0,0];
    let total = 0;
    primaryFeedbacks.forEach(f => {
      if (!f.rating) return;
      countsPrimary[f.rating-1]++;
      total += f.rating;
    });

    const avg = primaryFeedbacks.length ? (total / primaryFeedbacks.length).toFixed(2) : "-";
    document.getElementById("avgRating").textContent = avg;
    
    
    // --- 2. Vergleichs-Dataset (√úbung B) berechnen ---
    const datasets = [{
        label: document.getElementById("exerciseFilter").value || 'Gesamt', // Label f√ºr Prim√§r
        data: countsPrimary,
        backgroundColor: "#b30000" // Rot
    }];

    if (compareFeedbacks && selectedCompare) { // üî• Nur hinzuf√ºgen, wenn Vergleich gew√§hlt
        const countsCompare = [0,0,0,0,0];
        compareFeedbacks.forEach(f => {
            if (!f.rating) return;
            countsCompare[f.rating-1]++;
        });
        
        datasets.push({
            label: selectedCompare, // Label f√ºr Vergleich
            data: countsCompare,
            backgroundColor: "#005a9c" // Blau (oder eine andere Kontrastfarbe)
        });
        
        // Optional: Durchschnitt des Vergleichs in der Konsole loggen
        const avgCompare = compareFeedbacks.length ? (compareFeedbacks.reduce((sum, f) => sum + f.rating, 0) / compareFeedbacks.length).toFixed(2) : "-";
        console.log(`[Vergleich] ${selectedCompare} Durchschnitt: ${avgCompare}`);
    }
    
    // --- 3. Diagramm rendern ---
    const ctx = document.getElementById("feedbackChart").getContext("2d");
    if (window.chartInstance) window.chartInstance.destroy();
    window.chartInstance = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["1","2","3","4","5"],
        datasets: datasets, // üî• Verwendung beider Datasets
      },
      options: { scales: { y: { beginAtZero: true } } }
    });

    // --- 4. Kommentare rendern (bleibt bei der prim√§ren √úbung) ---
    const list = document.getElementById("commentsList");
    const currentEx = document.getElementById("exerciseFilter").value; 
    
    // ... (Kommentare Logik, bitte mit der Korrektur aus der letzten Antwort √ºbernehmen) ...
    if (primaryFeedbacks.length === 0) {
      list.innerHTML = "<li>Keine R√ºckmeldungen vorhanden.</li>";
    } else {
      list.innerHTML = primaryFeedbacks
        .filter(f => f.comment)
        .map(f => {
             const prefix = currentEx ? '' : `[${f.exercise || "‚Äì"}] `;
             return `<li>${prefix}${f.comment}</li>`;
        })
        .join('');
    }

    window.currentFeedbacks = feedbacks;
    window.currentExercise = document.getElementById("exerciseFilter").value;
  }

  // === PDF Export ===
  async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const feedbacks = window.currentFeedbacks || [];
    if (!feedbacks.length) return alert("Keine Feedbacks zum Exportieren!");
    const exercise = window.currentExercise || "Gesamt";

    doc.setFontSize(18);
    doc.text(`Feuerwehr Feedback ‚Äì ${exercise}`, 14, 20);
    doc.setFontSize(12);
    const avg = document.getElementById("avgRating").textContent;
    doc.text(`Durchschnittsbewertung: ${avg}`, 14, 30);
    doc.text(`Anzahl Feedbacks: ${feedbacks.length}`, 14, 37);

    let y = 50;
    feedbacks.forEach((f, i) => {
      const comment = f.comment || "";
      const line = `${i + 1}. [${f.rating}/5] ${comment}`;
      const split = doc.splitTextToSize(line, 180);
      doc.text(split, 14, y);
      y += split.length * 7;
      if (y > 270) { doc.addPage(); y = 20; }
    });

    doc.save(`Feedback_${exercise}_${new Date().toISOString().slice(0,10)}.pdf`);
  }
  window.exportPDF = exportPDF;



    // === Alte Feedbacks l√∂schen ===
    async function deleteOldFeedbacks() {
        // Stichtag berechnen: Heute minus 2 Jahre (in ISO-String-Format)
        const twoYearsAgo = new Date();
        twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
        const cutOffTimestamp = twoYearsAgo.toISOString();
        
        // Doppelte Sicherheitsabfrage
        if (!confirm(`M√∂chtest du WIRKLICH alle Feedbacks l√∂schen, die √§lter als ${twoYearsAgo.toLocaleDateString()} sind? Dieser Schritt kann NICHT r√ºckg√§ngig gemacht werden.`)) {
            return;
        }
    
        try {
            const feedbacksRef = collection(db, "feedbacks");
            // Abfrage: Suche Feedbacks, deren 'timestamp' (string) vor dem Stichtag liegt
            const q = query(
                feedbacksRef, 
                orderBy("timestamp"),
                where("timestamp", "<", cutOffTimestamp)
            );
            
            const qSnap = await getDocs(q);
            const count = qSnap.docs.length;
    
            if (count === 0) {
                alert("Es wurden keine Feedbacks gefunden, die √§lter als 2 Jahre sind.");
                return;
            }
    
            // Batch-L√∂schung (effizienter, falls es sehr viele Feedbacks sind, 
            // hier machen wir es einfach mit individuellem L√∂schen)
            
            console.log(`[Datenhygiene] L√∂sche ${count} alte Feedbacks...`);
            
            const deletePromises = qSnap.docs.map(d => deleteDoc(doc(db, "feedbacks", d.id)));
            
            await Promise.all(deletePromises);
            
            alert(`${count} Feedbacks, die √§lter als 2 Jahre sind, wurden erfolgreich gel√∂scht.`);
            
        } catch (e) {
            console.error("Fehler beim L√∂schen alter Feedbacks:", e);
            alert("Fehler beim L√∂schen alter Feedbacks. Pr√ºfe die Konsole.");
        }
    }
    
    window.deleteOldFeedbacks = deleteOldFeedbacks; // Funktion global verf√ºgbar machen
      
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f7f7f7; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 750px; margin: auto; }
    h1,h2 { color: #b30000; }
    #content { display: none; }
    #avgRating { font-size: 1.4em; font-weight: bold; }
    select, button {
      background: #b30000; color: white; border: none; padding: 8px 14px;
      border-radius: 6px; cursor: pointer; margin-bottom: 10px;
    }
    button:hover { background: #e00000; }
    select { margin-right: 8px; }
  </style>
</head>

<body>
  <div id="content">
    <div class="card">
      <h1>üìä Feuerwehr Feedback ‚Äì Auswertung</h1>
      <p>Durchschnittsbewertung: <span id="avgRating">-</span></p>
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <select id="exerciseFilter" onchange="applyFilter()"></select>

        <select id="compareFilter" onchange="applyFilter()">
          <option value="" selected>Kein Vergleich</option>
        </select>
        
        <button onclick="addExercise()">‚ûï Hinzuf√ºgen</button>
        <button onclick="deleteExercise()">üóëÔ∏è L√∂schen</button>
        <button onclick="toggleLockStatus()" id="lockButton">üîí √úbung sperren</button>
        <button onclick="exportPDF()">üìÑ PDF exportieren</button>
        <button onclick="deleteOldFeedbacks()">üßπ Feedbacks >2 J. l√∂schen</button>
      </div>
      <canvas id="feedbackChart"></canvas>
    </div>

    <div class="card">
      <h2>üí¨ Kommentare</h2>
      <ul id="commentsList"></ul>
    </div>
  </div>
</body>
</html>
