<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { 
    getFirestore, collection, onSnapshot, query, orderBy, 
    addDoc, getDocs, deleteDoc, doc , where, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  // Import der Konfiguration
  import { firebaseConfig } from "./firebase-config.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const PIN = "112";

  // === Startschutz ===
  window.addEventListener("DOMContentLoaded", () => {
    const entered = prompt("PIN eingeben:");
    if (entered === PIN) {
      document.getElementById("content").style.display = "block";
      loadExercises();
      loadFeedback();
    } else {
      alert("Falsche PIN – Zugriff verweigert.");
    }
  });

  // === Übung sperren/entsperren ===
async function toggleLockStatus() {
    const select = document.getElementById("exerciseFilter");
    const selected = select.value;
    if (!selected) return alert("Bitte eine Übung auswählen.");

    try {
        const qSnap = await getDocs(collection(db, "exercises"));
        let currentStatus = null;
        let docRef = null;

        // Finde das passende Dokument und den aktuellen Status
        qSnap.forEach((d) => {
            const data = d.data();
            if (data.name === selected) {
                currentStatus = !!data.isLocked; // Konvertiert zu Boolean, false falls Feld fehlt
                docRef = doc(db, "exercises", d.id);
            }
        });
        
        if (!docRef) return alert("Übung nicht in Datenbank gefunden.");

        const newStatus = !currentStatus;
        
        // Aktualisiere den Status in Firestore
        await updateDoc(docRef, {
            isLocked: newStatus
        });

        alert(`Übung "${selected}" wurde ${newStatus ? 'Gesperrt' : 'Entsperrt'}.`);
        
        // Aktualisiere den Button-Text sofort
        updateLockButtonText(newStatus); 
        
    } catch (e) {
        console.error("Fehler beim Sperren/Entsperren:", e);
        alert("Fehler beim Ändern des Status!");
    }
}
window.toggleLockStatus = toggleLockStatus;


// === Zusätzliche Funktion: Button-Text aktualisieren ===
// Stellt sicher, dass der Buttontext nach der Filterauswahl den korrekten Status anzeigt.
function updateLockButtonText(isLocked) {
    const btn = document.getElementById('lockButton');
    btn.textContent = isLocked ? '✅ Übung entsperren' : '🔒 Übung sperren';
    btn.style.backgroundColor = isLocked ? '#00703c' : '#b30000'; // Grüne oder rote Farbe
}
// Rufe diese Funktion auch im applyFilter auf, um den Status der gewählten Übung anzuzeigen.
window.updateLockButtonText = updateLockButtonText;

  // === Feedbacks live laden ===
  function loadFeedback() {
    const q = query(collection(db, "feedbacks"), orderBy("timestamp", "desc"));
    onSnapshot(q, (snapshot) => {
      const feedbacks = [];
      snapshot.forEach((d) => feedbacks.push(d.data()));
      window.allFeedbacks = feedbacks;
      console.log("[Feedback] geladen:", feedbacks.length);
      // Wenn noch keine Übung gewählt, Standard auf erste setzen
      const current = document.getElementById("exerciseFilter")?.value;
      if (!current) updateChart(feedbacks);
      else applyFilter();
    });
  }

  // === Übungen live laden ===
  function loadExercises() {
    const selectPrimary = document.getElementById("exerciseFilter");
    const selectCompare = document.getElementById("compareFilter"); // 🔥 NEU
    if (!selectPrimary || !selectCompare) return;
    const ref = collection(db, "exercises");

    onSnapshot(ref, (snapshot) => {
      selectPrimary.innerHTML = "";
      selectCompare.innerHTML = '<option value="" selected>Kein Vergleich</option>'; // 🔥 Vergleichsfilter initialisieren

      const names = [];
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        if (data?.name) {
          names.push(data.name);
          window.exerciseStatuses = window.exerciseStatuses || {};
          window.exerciseStatuses[data.name] = !!data.isLocked;
        }
      });
      names.sort((a,b) => a.localeCompare(b,"de"));

      // Option "Alle Übungen" für den Hauptfilter hinzufügen
      const allOpt = document.createElement("option");
      allOpt.value = "";
      allOpt.textContent = "Alle Übungen (Gesamt)";
      selectPrimary.appendChild(allOpt);

      names.forEach((n) => {
        // Optionen für Hauptfilter
        let optP = document.createElement("option");
        optP.value = n;
        optP.textContent = n;
        selectPrimary.appendChild(optP);
        
        // 🔥 Optionen für Vergleichsfilter
        let optC = document.createElement("option");
        optC.value = n;
        optC.textContent = n;
        selectCompare.appendChild(optC);
      });
      console.log("[Übungen] aktualisiert:", names.length, "plus Alle-Option");

      if (window.allFeedbacks) applyFilter();
      const initialEx = document.getElementById("exerciseFilter").value;
      if(initialEx && window.exerciseStatuses) updateLockButtonText(window.exerciseStatuses[initialEx]);
    }, (err) => console.error("[Übungen] Fehler:", err));
}

  // === Übung hinzufügen ===
  async function addExercise() {
    const newEx = prompt("Neue Übung hinzufügen:");
    if (!newEx || !newEx.trim()) return;
    const name = newEx.trim();
    try {
      await addDoc(collection(db, "exercises"), {
        name,
        createdAt: new Date().toISOString()
      });
      alert(`Übung "${name}" wurde hinzugefügt.`);
    } catch (e) {
      console.error("Fehler beim Speichern:", e);
    }
  }

  // === Übung löschen ===
  async function deleteExercise() {
    const select = document.getElementById("exerciseFilter");
    const selected = select.value;
    if (!selected) return alert("Bitte eine Übung auswählen.");
    if (!confirm(`Möchtest du "${selected}" wirklich löschen?`)) return;
    try {
      const qSnap = await getDocs(collection(db, "exercises"));
      qSnap.forEach(async (d) => {
        const data = d.data();
        if (data.name === selected) {
          await deleteDoc(doc(db, "exercises", d.id));
        }
      });
      alert(`Übung "${selected}" wurde gelöscht.`);
    } catch (e) {
      console.error("Fehler beim Löschen:", e);
    }
  }

  window.addExercise = addExercise;
  window.deleteExercise = deleteExercise;

  // === Filter & Diagramm ===
  function applyFilter() {
      const selectedPrimary = document.getElementById("exerciseFilter").value;
      const selectedCompare = document.getElementById("compareFilter").value; // 🔥 NEU
      
      const all = window.allFeedbacks || [];
      
      // 1. Primäres Dataset filtern
      const primaryFeedbacks = selectedPrimary ? all.filter(f => f.exercise === selectedPrimary) : all;
      window.currentFeedbacks = primaryFeedbacks;
      window.currentExercise = selectedPrimary || "Gesamt";
  
      // 2. Vergleichs-Dataset filtern
      let compareFeedbacks = [];
      if (selectedCompare) {
          compareFeedbacks = all.filter(f => f.exercise === selectedCompare);
      }
      if (window.exerciseStatuses && selectedPrimary) {
        updateLockButtonText(window.exerciseStatuses[selectedPrimary]);
    } else {
        updateLockButtonText(false); // Wenn 'Alle Übungen' oder keine Übung gewählt
    }
      
      updateChart(primaryFeedbacks, compareFeedbacks, selectedCompare); // 🔥 Übergabe beider Datensets
  }
  window.applyFilter = applyFilter;

  function updateChart(primaryFeedbacks, compareFeedbacks, selectedCompare) { // 🔥 Parameter hinzugefügt
    
    // --- 1. Primäres Dataset (Übung A) berechnen ---
    const countsPrimary = [0,0,0,0,0];
    let total = 0;
    primaryFeedbacks.forEach(f => {
      if (!f.rating) return;
      countsPrimary[f.rating-1]++;
      total += f.rating;
    });

    const avg = primaryFeedbacks.length ? (total / primaryFeedbacks.length).toFixed(2) : "-";
    document.getElementById("avgRating").textContent = avg;
    
    
    // --- 2. Vergleichs-Dataset (Übung B) berechnen ---
    const datasets = [{
        label: document.getElementById("exerciseFilter").value || 'Gesamt', // Label für Primär
        data: countsPrimary,
        backgroundColor: "#b30000" // Rot
    }];

    if (compareFeedbacks && selectedCompare) { // 🔥 Nur hinzufügen, wenn Vergleich gewählt
        const countsCompare = [0,0,0,0,0];
        compareFeedbacks.forEach(f => {
            if (!f.rating) return;
            countsCompare[f.rating-1]++;
        });
        
        datasets.push({
            label: selectedCompare, // Label für Vergleich
            data: countsCompare,
            backgroundColor: "#005a9c" // Blau (oder eine andere Kontrastfarbe)
        });
        
        // Optional: Durchschnitt des Vergleichs in der Konsole loggen
        const avgCompare = compareFeedbacks.length ? (compareFeedbacks.reduce((sum, f) => sum + f.rating, 0) / compareFeedbacks.length).toFixed(2) : "-";
        console.log(`[Vergleich] ${selectedCompare} Durchschnitt: ${avgCompare}`);
    }
    
    // --- 3. Diagramm rendern ---
    const ctx = document.getElementById("feedbackChart").getContext("2d");
    if (window.chartInstance) window.chartInstance.destroy();
    window.chartInstance = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["1","2","3","4","5"],
        datasets: datasets, // 🔥 Verwendung beider Datasets
      },
      options: { scales: { y: { beginAtZero: true } } }
    });

    // --- 4. Kommentare rendern (bleibt bei der primären Übung) ---
    const list = document.getElementById("commentsList");
    const currentEx = document.getElementById("exerciseFilter").value; 
    
    // ... (Kommentare Logik, bitte mit der Korrektur aus der letzten Antwort übernehmen) ...
    if (primaryFeedbacks.length === 0) {
      list.innerHTML = "<li>Keine Rückmeldungen vorhanden.</li>";
    } else {
      list.innerHTML = primaryFeedbacks
        .filter(f => f.comment)
        .map(f => {
             const prefix = currentEx ? '' : `[${f.exercise || "–"}] `;
             return `<li>${prefix}${f.comment}</li>`;
        })
        .join('');
    }

    window.currentFeedbacks = feedbacks;
    window.currentExercise = document.getElementById("exerciseFilter").value;
  }

  // === PDF Export ===
  async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const feedbacks = window.currentFeedbacks || [];
    if (!feedbacks.length) return alert("Keine Feedbacks zum Exportieren!");
    const exercise = window.currentExercise || "Gesamt";

    doc.setFontSize(18);
    doc.text(`Feuerwehr Feedback – ${exercise}`, 14, 20);
    doc.setFontSize(12);
    const avg = document.getElementById("avgRating").textContent;
    doc.text(`Durchschnittsbewertung: ${avg}`, 14, 30);
    doc.text(`Anzahl Feedbacks: ${feedbacks.length}`, 14, 37);

    let y = 50;
    feedbacks.forEach((f, i) => {
      const comment = f.comment || "";
      const line = `${i + 1}. [${f.rating}/5] ${comment}`;
      const split = doc.splitTextToSize(line, 180);
      doc.text(split, 14, y);
      y += split.length * 7;
      if (y > 270) { doc.addPage(); y = 20; }
    });

    doc.save(`Feedback_${exercise}_${new Date().toISOString().slice(0,10)}.pdf`);
  }
  window.exportPDF = exportPDF;



    // === Alte Feedbacks löschen ===
    async function deleteOldFeedbacks() {
        // Stichtag berechnen: Heute minus 2 Jahre (in ISO-String-Format)
        const twoYearsAgo = new Date();
        twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
        const cutOffTimestamp = twoYearsAgo.toISOString();
        
        // Doppelte Sicherheitsabfrage
        if (!confirm(`Möchtest du WIRKLICH alle Feedbacks löschen, die älter als ${twoYearsAgo.toLocaleDateString()} sind? Dieser Schritt kann NICHT rückgängig gemacht werden.`)) {
            return;
        }
    
        try {
            const feedbacksRef = collection(db, "feedbacks");
            // Abfrage: Suche Feedbacks, deren 'timestamp' (string) vor dem Stichtag liegt
            const q = query(
                feedbacksRef, 
                orderBy("timestamp"),
                where("timestamp", "<", cutOffTimestamp)
            );
            
            const qSnap = await getDocs(q);
            const count = qSnap.docs.length;
    
            if (count === 0) {
                alert("Es wurden keine Feedbacks gefunden, die älter als 2 Jahre sind.");
                return;
            }
    
            // Batch-Löschung (effizienter, falls es sehr viele Feedbacks sind, 
            // hier machen wir es einfach mit individuellem Löschen)
            
            console.log(`[Datenhygiene] Lösche ${count} alte Feedbacks...`);
            
            const deletePromises = qSnap.docs.map(d => deleteDoc(doc(db, "feedbacks", d.id)));
            
            await Promise.all(deletePromises);
            
            alert(`${count} Feedbacks, die älter als 2 Jahre sind, wurden erfolgreich gelöscht.`);
            
        } catch (e) {
            console.error("Fehler beim Löschen alter Feedbacks:", e);
            alert("Fehler beim Löschen alter Feedbacks. Prüfe die Konsole.");
        }
    }
    
    window.deleteOldFeedbacks = deleteOldFeedbacks; // Funktion global verfügbar machen
      
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f7f7f7; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 750px; margin: auto; }
    h1,h2 { color: #b30000; }
    #content { display: none; }
    #avgRating { font-size: 1.4em; font-weight: bold; }
    select, button {
      background: #b30000; color: white; border: none; padding: 8px 14px;
      border-radius: 6px; cursor: pointer; margin-bottom: 10px;
    }
    button:hover { background: #e00000; }
    select { margin-right: 8px; }
  </style>
</head>

<body>
  <div id="content">
    <div class="card">
      <h1>📊 Feuerwehr Feedback – Auswertung</h1>
      <p>Durchschnittsbewertung: <span id="avgRating">-</span></p>
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <select id="exerciseFilter" onchange="applyFilter()"></select>

        <select id="compareFilter" onchange="applyFilter()">
          <option value="" selected>Kein Vergleich</option>
        </select>
        
        <button onclick="addExercise()">➕ Hinzufügen</button>
        <button onclick="deleteExercise()">🗑️ Löschen</button>
        <button onclick="toggleLockStatus()" id="lockButton">🔒 Übung sperren</button>
        <button onclick="exportPDF()">📄 PDF exportieren</button>
        <button onclick="deleteOldFeedbacks()">🧹 Feedbacks >2 J. löschen</button>
      </div>
      <canvas id="feedbackChart"></canvas>
    </div>

    <div class="card">
      <h2>💬 Kommentare</h2>
      <ul id="commentsList"></ul>
    </div>
  </div>
</body>
</html>
