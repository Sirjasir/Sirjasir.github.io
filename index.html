<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Feuerwehr Feedback</title>
  <link rel="stylesheet" href="style.css">

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    // Import der Konfiguration
    import { firebaseConfig } from "./firebase-config.js";

    // === Firebase starten ===
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // === Live alle √úbungen aus Firestore laden ===
    function loadExercises() {
      const select = document.getElementById("exercise");
      if (!select) return;

      const ref = collection(db, "exercises");
      onSnapshot(ref, (snapshot) => {
        const names = [];
        window.lockedExercises = {};
        
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data?.name) {
            names.push(data.name);
            if (data.isLocked) {
              window.lockedExercises[data.name] = true;
            }
          }
        });

        names.sort((a, b) => a.localeCompare(b, "de"));
        select.innerHTML = ""; // Dropdown leeren
        if (names.length === 0) {
          // Fallback, falls noch keine √úbung existiert
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Keine √úbung verf√ºgbar";
          select.appendChild(opt);
          select.disabled = true;
        } else {
          select.disabled = false;
          names.forEach(n => {
            const opt = document.createElement("option");
            opt.value = n;
            opt.textContent = n;
            if (window.lockedExercises[n]) {
                opt.textContent += " (Gesperrt)";
            }
            select.appendChild(opt);
          });
          
        }
        checkLockStatus();
        console.log("[LiveSync] √úbungen:", names);
      }, (err) => {
        console.error("[LiveSync] Fehler beim Laden der √úbungen:", err);
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Fehler beim Laden";
        select.appendChild(opt);
      });
    }

    window.addEventListener("DOMContentLoaded", loadExercises);

    function checkLockStatus() {
        const exerciseSelect = document.getElementById('exercise');
        const selectedExercise = exerciseSelect.value;
        const isLocked = window.lockedExercises && window.lockedExercises[selectedExercise];
        
        // Deaktiviere alle Formular-Elemente und den Absenden-Button, wenn gesperrt
        const ratingSelect = document.getElementById('rating');
        const commentArea = document.getElementById('comment');
        const submitButton = document.querySelector('button[onclick="saveFeedback()"]');
        
        ratingSelect.disabled = isLocked;
        commentArea.disabled = isLocked;
        submitButton.disabled = isLocked;
        submitButton.textContent = isLocked ? 'Feedback gesperrt' : 'Absenden';
        submitButton.style.backgroundColor = isLocked ? '#555' : '#b30000';
        
        // F√ºge einen Event-Listener hinzu, um bei Auswahlwechsel sofort zu pr√ºfen
        exerciseSelect.onchange = checkLockStatus;
    }

    // === Feedback speichern ===
    async function saveFeedback() {
      const rating = document.getElementById('rating').value;
      const comment = document.getElementById('comment').value.trim();
      const exerciseSelect = document.getElementById('exercise');
      const exercise = exerciseSelect ? exerciseSelect.value : "";

      if (window.lockedExercises && window.lockedExercises[exercise]) {
          alert("Diese √úbung wurde gesperrt und kann kein Feedback mehr annehmen.");
          return;
      }

      if (!exercise || exerciseSelect.disabled) {
        alert("Es ist keine √úbung verf√ºgbar. Bitte wende dich an den Administrator.");
        return;
      }
      if (!rating) return alert("Bitte eine Bewertung ausw√§hlen!");

      try {
        await addDoc(collection(db, "feedbacks"), {
          rating: Number(rating),
          comment: comment,
          exercise: exercise,
          timestamp: new Date().toISOString()
        });
        document.getElementById('comment').value = '';
        alert("Danke f√ºr dein Feedback!");
      } catch (e) {
        console.error("Fehler beim Hinzuf√ºgen des Feedbacks:", e);
        alert("Fehler beim Speichern deines Feedbacks!");
      }
    }

    window.saveFeedback = saveFeedback;
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f7f7f7;
    }
    h1 {
      color: #b30000;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: auto;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    textarea, select, input {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 20px;
      background: #b30000;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #e00000;
    }
    p.note {
      font-size: 0.9em;
      color: #555;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>üßØ Feuerwehr Feedback</h1>
    <p>Hier kannst du anonym Feedback zu √úbungen geben. Keine Namen, kein Login ‚Äì nur ehrliche R√ºckmeldung.</p>

    <label for="exercise">√úbung:</label>
    <select id="exercise"></select>

    <label for="rating">Bewertung (1 = schlecht, 5 = super):</label>
    <select id="rating">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <label for="comment">Kommentar (optional):</label>
    <textarea id="comment" rows="3" placeholder="Was war gut, was kann besser werden?"></textarea>

    <button onclick="saveFeedback()">Absenden</button>
    <p class="note">Alle Eingaben sind anonym. Die Auswertung erfolgt gesammelt in der Statistikseite.</p>
  </div>
</body>
</html>
